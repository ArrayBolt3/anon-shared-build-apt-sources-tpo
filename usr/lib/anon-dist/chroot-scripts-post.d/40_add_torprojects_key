#!/bin/bash

## This file is part of Whonix.
## Copyright (C) 2012 - 2014 Patrick Schleizer <adrelanos@riseup.net>
## See the file COPYING for copying conditions.

set -x
set -o pipefail

error_handler() {
   echo "
#############################################################
## chroot script: ERROR detected. Please report this bug! #
#############################################################
"

   exit 1
}

## {{ Set up error handler.
if [ "$(type -t error_handler_general)" = "function" ]; then
   ## Function error_handler_general exists (declared in
   ## help-steps/pre). Prefer to use the more feature rich version of the error
   ## handler.
   trap "error_handler_general" ERR
else
   ## Function error_handler_general does not exist. Script
   ## runs standalone outside the build script. Fall back to a simpler error
   ## handler.
   trap "error_handler" ERR
fi
## }}

own_filename="$(basename "$BASH_SOURCE")"
for skip_script in $SKIP_SCRIPTS; do
   if [ "$skip_script" = "$own_filename" ]; then
      true "INFO: Skipping $own_filename, because SKIP_SCRIPTS includes it."
      exit 0
   fi
done
unset skip_script

## The torproject archive key has been manually downloaded using the key fingerprint from
## https://www.torproject.org/docs/debian.html.en and https://www.torproject.org/docs/signing-keys.html.en
## using gpg:
##    gpg --keyserver keys.gnupg.net --recv <long-key-id>
## Verified using:
##    gpg --list-sigs <long-key-id>
##    gpg --check-sigs <long-key-id>
## And added to Whonix source code using:
##    gpg --export <long-key-id> > /home/user/anon-shared-build-apt-sources-tpo/usr/share/anon-shared-build-apt-sources-tpo/tpoarchive-keys.d/torprojectarchive.asc

for key in "/usr/share/anon-shared-build-apt-sources-tpo/tpoarchive-keys.d/"*; do
   filename="$(basename "$key")"
   if [ "$filename" = "placeholder" ]; then
      continue
   fi
   if [ "$filename" = "*" ]; then
      ## Folder is empty.
      continue
   fi
   apt-key add "$key"
done

## This is a chroot-script and not a postinst.d script,
## because when the user updates, the deb.torproject.org-keyring deb package is already
## installed, which does a better job updating Tor Project's signing key.

## Explicitly "exit 0", so eventually trapped errors can be ignored.
exit 0
